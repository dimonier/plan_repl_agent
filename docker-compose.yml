services:
  agent:
    build: .
    user: "${UID:-1000}:${GID:-1000}"
    ports:
      - "127.0.0.1:8000:8000"  # Only localhost access
    volumes:
      - ./agent:/app/agent  # Agent code (auto-reload if enabled)
      - ./work:/app/work  # Work dir for agent files (clean user space)
      - ./lib:/app/lib  # Technical infrastructure (.pydeps, .matplotlib, etc.)
      - ./logs:/app/logs  # Logs visible on host
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    env_file:
      - .env
    environment:
      # Agent can pip install to writable location in lib/
      - PIP_TARGET=/app/lib/.pydeps
      - PYTHONPATH=/app/lib/.pydeps
      - PIP_CACHE_DIR=/app/lib/.pipcache
      - PIP_DISABLE_PIP_VERSION_CHECK=1
      - PIP_NO_INPUT=1
      - PIP_NO_WARN_SCRIPT_LOCATION=1
      # Matplotlib config in writable location in lib/
      - MPLCONFIGDIR=/app/lib/.matplotlib
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    # Network restrictions (optional)
    # network_mode: "none"  # Uncomment to disable network
    
    # Security options
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    # Port 8000 doesn't need NET_BIND_SERVICE (only ports < 1024 require it)
    
    # Restart policy
    restart: unless-stopped
